# Quoted DB Migration

This is a CLI that can be run to generate, apply, revert migrations.

Note:
- You must have a `.env` file in your workspace root, and it must have a `DATABASE_URL` with the connection string to your database
- You should run all commands from the workspace root.
- We're mixing and matching running the [sea-orm-cli](https://crates.io/crates/sea-orm-cli) and the generated cli in this crate. This is because some of the commands in the crate expect to be run from the crate directory rather than the workspace directory.

## Useful commands

### Generate new migration

Creates a new migration in `quoted_db_migration/src/`. 
```
sea-orm-cli migrate generate --migration-dir ./quoted_db_migration new_migration_name
```

Once the migration file is created, you need to [write the migration](https://www.sea-ql.org/SeaORM/docs/next/migration/writing-migration/).

### Deploy migration

Once you have written a migration and are ready to deploy it, you can do so with:

```
cargo run --bin quoted_db_migration -- up
```

### Generate entities from schema

After deploying the migration, we can generate our entities based on the deployed schema changes.
This will output the new entities to `quoted_db_entity/src/`.

```
sea-orm-cli generate entity -o ./quoted_db_entity/src
```
After running this command, a new module will be created in `quoted_db_entity/src`. You need to 
expose it by adding `pub mod <entity-name>;` to [`quoted_db_entity/src/lib.rs`](../quoted_db_entity/src/lib.rs).

### Default info generated by `sea-orm-cli migrate init`

- Generate a new migration file
    ```sh
    cargo run -- generate MIGRATION_NAME
    ```
- Apply all pending migrations
    ```sh
    cargo run
    ```
    ```sh
    cargo run -- up
    ```
- Apply first 10 pending migrations
    ```sh
    cargo run -- up -n 10
    ```
- Rollback last applied migrations
    ```sh
    cargo run -- down
    ```
- Rollback last 10 applied migrations
    ```sh
    cargo run -- down -n 10
    ```
- Drop all tables from the database, then reapply all migrations
    ```sh
    cargo run -- fresh
    ```
- Rollback all applied migrations, then reapply all migrations
    ```sh
    cargo run -- refresh
    ```
- Rollback all applied migrations
    ```sh
    cargo run -- reset
    ```
- Check the status of all migrations
    ```sh
    cargo run -- status
    ```
